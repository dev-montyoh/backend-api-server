name: Push Workflow (master)

on:
  push:
    branches:
      - master
  # 배포 테스트 임시 추가
  pull_request:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # 임시 gateway 하나만 지정
        service: [ gateway ]
    #        service: [ auth, content, gateway, payment, user ]

    steps:
      # 코드 체크아웃
      - name: Check out repository
        uses: actions/checkout@v5

      # 각 서비스 변경사항 추적
      - name: Get changed files
        id: changed
        uses: tj-actions/changed-files@v47
        with:
          files: '${{matrix.service}}/**'

      # 외부 private secrets store 접근
      - name: Check out Secrets store
        #if: steps.changed.outputs.any_changed == 'true'
        uses: actions/checkout@v5
        with:
          repository: 'dev-montyoh/secrets-store'
          token: ${{ secrets.SECRETS_STORE_ACCESS_TOKEN }}
          path: secrets-store

      # 외부 private secrets store 로드
      - name: Load secrets
        #if: steps.changed.outputs.any_changed == 'true'
        uses: ./secrets-store/.github/actions/load-secrets
        with:
          SECRETS_STORE_ACCESS_TOKEN: ${{ secrets.SECRETS_STORE_ACCESS_TOKEN }}

      # Github Registry 로그인
      - name: Log in to Github Registry
        #if: steps.changed.outputs.any_changed == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ env.DOCKER_REGISTRY_ACCESS_TOKEN }}

      - name: Deploy to EC2
        env:
          EC2_KEY_PATH: ./secrets-store/key/ec2-ssh-key
          EC2_USER: ec2-user
          EC2_HOST: ${{ env.EC2_PUBLIC_IP }}
          DOCKER_REGISTRY_ACCESS_TOKEN: ${{ env.DOCKER_REGISTRY_ACCESS_TOKEN }}
          DOCKER_REGISTRY_USERNAME: ${{ github.repository_owner }}
          TARGET_SERVICE: ${{ matrix.service }}
        run: |
          chmod 600 $EC2_KEY_PATH
          
          # 모든 env를 한 줄로 직렬화해서 전달
          ENV_VARS=$(env | sed 's/"/\\"/g' | awk '{printf "export \"%s\"\n", $0}')
          
          # SSH 연결 후 배포
          ssh -o StrictHostKeyChecking=no -i $EC2_KEY_PATH $EC2_USER@$EC2_HOST "
          
            # 실행에 필요한 각 환경변수 등록
            set -a
            ${ENV_VARS}
            set +a
          
            # 기존 서비스 및 이미지 삭제
            docker ps -q --filter "name=backend-api-server-$TARGET_SERVICE" | xargs -r docker stop
            docker ps -a -q --filter "name=backend-api-server-$TARGET_SERVICE" | xargs -r docker rm
            docker images -q ghcr.io/$DOCKER_REGISTRY_USERNAME/backend-api-server-$TARGET_SERVICE:latest | xargs -r docker rmi -f
          
            # docker-compose.yml 연결 및 특정 서비스 시작
            echo "$DOCKER_REGISTRY_ACCESS_TOKEN" | docker login ghcr.io -u $DOCKER_REGISTRY_USERNAME --password-stdin
            cd /home/ec2-user/app
            curl -L -o docker-compose.yml https://raw.githubusercontent.com/$DOCKER_REGISTRY_USERNAME/iac-terraform/refs/heads/master/docker-compose.yml
            docker-compose pull backend-api-server-$TARGET_SERVICE
            docker-compose up -d backend-api-server-$TARGET_SERVICE
          "
